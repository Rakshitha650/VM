name: Deploy and Verify Instance

on:
  push:
    branches:
      - main  # Change this if your default branch is different

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      AWS_REGION: us-east-1

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.5.6  # Change to match your required version

      - name: Terraform Init & Apply
        run: |
          terraform init
          terraform apply -auto-approve

      - name: Extract Instance IP
        run: |
          INSTANCE_IP=$(terraform output -raw instance_public_ip | grep -Eo '([0-9]{1,3}\.){3}[0-9]{1,3}')
          CLEANED_IP=$(echo "$INSTANCE_IP" | tr -d '[:space:]' | tr -d '\r')

          if [[ -z "$CLEANED_IP" ]]; then
            echo "‚ùå Error: Could not extract a valid IP address"
            exit 1
          fi

          echo "INSTANCE_IP=$CLEANED_IP" >> $GITHUB_ENV
          echo "‚úÖ Instance IP extracted: $CLEANED_IP"

      - name: Wait for Instance to be Reachable
        run: |
          echo "‚è≥ Waiting for instance to be reachable..."
          for i in {1..10}; do
            if ssh -o StrictHostKeyChecking=no -i mosip-qa.pem ubuntu@$INSTANCE_IP "echo Instance is ready"; then
              echo "‚úÖ Instance is reachable."
              break
            fi
            echo "üîÑ Retrying in 15 seconds..."
            sleep 15
          done

      - name: Deploy WireGuard on Instance
        run: |
          ssh -o StrictHostKeyChecking=no -i mosip-qa.pem ubuntu@$INSTANCE_IP << 'EOF'
            sudo apt-get update
            sudo apt-get install -y wireguard
            sudo ufw allow 51820/udp
            sudo systemctl enable wg-quick@wg0
            sudo systemctl start wg-quick@wg0
            echo "‚úÖ WireGuard setup completed!"
          EOF


      - name: Install Software on AWS VM
        run: |
          ssh -o StrictHostKeyChecking=no -i mosip-qa.pem ubuntu@${{ env.INSTANCE_IP }} << 'EOF'
          # Update and install required packages
          sudo apt update -y
          
          # Install Java JDK 11
          sudo apt install -y openjdk-11-jdk
          
          # Install JProfiler 13
          wget -O jprofiler.deb https://download.ej-technologies.com/jprofiler/jprofiler_linux_13_0_1.deb
          sudo dpkg -i jprofiler.deb || sudo apt-get install -f -y
          
          # Install VNC Server
          sudo apt install -y tightvncserver
          
          # Cleanup
          rm -f jprofiler.deb
          EOF
